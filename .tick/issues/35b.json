{
  "id": "35b",
  "title": "Add sync status and staleness tracking to API",
  "description": "Track and expose sync status in API responses so consumers know if data is stale or writes are safe.\n\n## Problem\n\n- Local .tick/ files are source of truth\n- DO is a cache that syncs via tk run --cloud\n- If local agent disconnects, DO data becomes stale\n- Writes to DO when local is offline create orphaned changes\n\nREST API consumers need to know:\n1. Is local agent connected?\n2. How stale is the data?\n3. Will my write actually sync to the repo?\n\n## Solution\n\n### 1. Track local connection status in DO\n\n```typescript\n// In ProjectRoom\nprivate localConnection: Connection | null = null;\nprivate lastLocalSync: number = 0;\n\n// On WebSocket connect with type=local\nif (connType === \"local\") {\n  this.localConnection = conn;\n  this.lastLocalSync = Date.now();\n}\n\n// On local disconnect\nif (conn === this.localConnection) {\n  this.localConnection = null;\n  // lastLocalSync retains last known sync time\n}\n\n// On any message from local\nif (conn === this.localConnection) {\n  this.lastLocalSync = Date.now();\n}\n```\n\n### 2. Include sync metadata in all API responses\n\n```typescript\ninterface SyncStatus {\n  localConnected: boolean;\n  lastLocalSync: string | null;  // ISO timestamp\n  staleSeconds: number | null;   // null if connected\n  canWrite: boolean;             // false if local offline\n}\n\nfunction getSyncStatus(): SyncStatus {\n  const connected = this.localConnection !== null;\n  const staleSeconds = connected ? null : \n    Math.floor((Date.now() - this.lastLocalSync) / 1000);\n  \n  return {\n    localConnected: connected,\n    lastLocalSync: this.lastLocalSync ? new Date(this.lastLocalSync).toISOString() : null,\n    staleSeconds,\n    canWrite: connected,  // Only allow writes when local is connected\n  };\n}\n\n// In GET /ticks response:\nreturn Response.json({\n  ticks: [...],\n  _sync: getSyncStatus(),\n});\n```\n\n### 3. Block writes when local is offline\n\n```typescript\n// In PATCH/POST/DELETE handlers:\nif (!this.localConnection) {\n  return Response.json({\n    error: \"Local agent offline - writes disabled\",\n    code: \"LOCAL_OFFLINE\",\n    _sync: getSyncStatus(),\n  }, { status: 503 });\n}\n```\n\n### 4. Optional: Allow offline writes with explicit header\n\nFor consumers who understand the risk:\n\n```typescript\nconst allowOffline = request.headers.get(\"X-Allow-Offline-Write\") === \"true\";\n\nif (!this.localConnection \u0026\u0026 !allowOffline) {\n  return Response.json({ error: \"...\" }, { status: 503 });\n}\n\n// If allowed, include warning in response\nif (!this.localConnection \u0026\u0026 allowOffline) {\n  return Response.json({\n    tick: updated,\n    _sync: getSyncStatus(),\n    _warning: \"Change saved to cloud but local agent offline. Will sync when agent reconnects.\",\n  });\n}\n```\n\n### 5. Persist lastLocalSync for DO restarts\n\n```typescript\n// In persistState()\nawait this.state.storage.put(\"lastLocalSync\", this.lastLocalSync);\n\n// In constructor blockConcurrencyWhile()\nthis.lastLocalSync = await this.state.storage.get\u003cnumber\u003e(\"lastLocalSync\") || 0;\n```\n\n## API response examples\n\n### Healthy state (local connected)\n```json\n{\n  \"ticks\": [...],\n  \"_sync\": {\n    \"localConnected\": true,\n    \"lastLocalSync\": \"2026-01-22T12:00:00Z\",\n    \"staleSeconds\": null,\n    \"canWrite\": true\n  }\n}\n```\n\n### Stale state (local offline 45 min)\n```json\n{\n  \"ticks\": [...],\n  \"_sync\": {\n    \"localConnected\": false,\n    \"lastLocalSync\": \"2026-01-22T11:15:00Z\",\n    \"staleSeconds\": 2700,\n    \"canWrite\": false\n  }\n}\n```\n\n### Write rejected (503)\n```json\n{\n  \"error\": \"Local agent offline - writes disabled\",\n  \"code\": \"LOCAL_OFFLINE\",\n  \"_sync\": {\n    \"localConnected\": false,\n    \"lastLocalSync\": \"2026-01-22T11:15:00Z\",\n    \"staleSeconds\": 2700,\n    \"canWrite\": false\n  }\n}\n```\n\n## Files to modify\n\n- cloud/worker/src/project-room.ts",
  "notes": "2026-01-23 19:25 - (from: cloud) test comment\n2026-01-23 19:25 - (from: cloud) test comment 2",
  "status": "open",
  "priority": 1,
  "type": "task",
  "owner": "peter@engelbrecht.dk",
  "labels": [
    "api",
    "sync",
    "reliability"
  ],
  "parent": "qr4",
  "created_by": "peter@engelbrecht.dk",
  "created_at": "2026-01-22T07:43:59.816457Z",
  "updated_at": "2026-01-23T19:25:44.005075+01:00"
}